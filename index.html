<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Sakini Portalı</title>
    <style>
        :root { --primary: #1e3a8a; --bg: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 450px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: var(--primary); color: white; font-size: 16px; }
        .debt-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .debt-value { color: #dc2626; font-weight: bold; }
        .announcement { background: #e0f2fe; padding: 12px; margin: 10px 0; border-radius: 8px; font-size: 0.9em; border-left: 4px solid #3b82f6; }
        textarea { width: 100%; height: 80px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; padding: 10px; box-sizing: border-box; }
        .time-badge { background: #fee2e2; color: #991b1b; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.8em; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="login-screen" class="card">
        <h2 style="text-align:center; color:#1e3a8a;">Site Girişi</h2>
        <p style="text-align:center; color:gray; font-size:0.8em;">(Veriler Google Tablo'dan Anlık Alınır)</p>
        <input type="text" id="username" placeholder="Kullanıcı Adı">
        <input type="password" id="password" placeholder="Şifre">
        <button id="entryBtn" class="btn" onclick="sadeceGoogleVerisiIleGiris()">Giriş Yap</button>
    </div>

    <div id="main-panel" class="card" style="display: none;">
        <h3 id="welcome-msg" style="margin-top:0;"></h3>
        <div id="duyuru-alani"></div>
        
        <div style="margin: 20px 0;">
            <div class="debt-row"><span>Aidat:</span><span id="aidat" class="debt-value"></span></div>
            <div class="debt-row"><span>Yakıt:</span><span id="yakit" class="debt-value"></span></div>
            <div class="debt-row"><span>Diğer:</span><span id="diger" class="debt-value"></span></div>
        </div>

        <hr>
        <h4>Site Forumu</h4>
        <div id="mesaj-yazma-alani"></div>
        <div id="forum-list" style="margin-top:10px; font-size: 0.85em;"></div>

        <button class="btn" style="background:#64748b; margin-top:20px;" onclick="location.reload()">Güvenli Çıkış</button>
    </div>
</div>

<script>
// KESİN VE TEK VERİ KAYNAĞI: Google Sheets CSV
const gSheetLink = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrCjNVASPnz9j40KxsZ7nCoIMBuqQLmxLiXmUM-CXTAp0cW03lM0YlJQMf7IJ054QmTvlTXp3iLMYj/pub?output=csv";

async function sadeceGoogleVerisiIleGiris() {
    const u = document.getElementById('username').value.trim().toLowerCase();
    const p = document.getElementById('password').value.trim();
    const btn = document.getElementById('entryBtn');

    if (!u || !p) return alert("Lütfen boş alan bırakmayın.");

    btn.innerText = "Tabloya Bağlanılıyor...";
    btn.disabled = true;

    try {
        // GitHub'daki hiçbir dosyaya bakma, doğrudan Google'a git
        // Sona eklenen cache=... kısmı tarayıcının eski veriyi göstermesini engeller
        const response = await fetch(gSheetLink + "&cache=" + new Date().getTime());
        const csvText = await response.text();
        
        const satirlar = csvText.split(/\r?\n/).filter(s => s.trim() !== '');
        const ayirici = satirlar[0].includes(';') ? ';' : ',';
        const basliklar = satirlar[0].split(ayirici).map(b => b.trim().replace(/^"|"$/g, '').toLowerCase());
        
        const veriler = satirlar.slice(1).map(satir => {
            const degerler = satir.split(ayirici).map(d => d.trim().replace(/^"|"$/g, ''));
            let obje = {};
            basliklar.forEach((baslik, index) => { obje[baslik] = degerler[index] || ""; });
            return obje;
        });

        const kisi = veriler.find(d => 
            (d.username && d.username.toLowerCase() === u) && (String(d.password) === p)
        );

        if (kisi) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-panel').style.display = 'block';
            
            document.getElementById('welcome-msg').innerText = "Sn. " + (kisi.sahibi || kisi.username);
            document.getElementById('aidat').innerText = (kisi.aidatborcu || "0") + " TL";
            document.getElementById('yakit').innerText = (kisi.yakitborcu || "0") + " TL";
            document.getElementById('diger').innerText = (kisi.digerborc || "0") + " TL";
            
            if(kisi.not) {
                document.getElementById('duyuru-alani').innerHTML = `<div class="announcement"><b>Yönetici Notu:</b> ${kisi.not}</div>`;
            }
            
            // Forumu forum.json'dan çekmeye çalışalım
            fetch('./forum.json?v=' + Math.random()).then(r => r.json()).then(f => {
                const list = document.getElementById('forum-list');
                list.innerHTML = (f.mesajlar || []).reverse().map(m => `<div><b>${m.kisi}:</b> ${m.mesaj}</div>`).join('');
            }).catch(() => console.log("Forum dosyası yok."));

            saatAyari(kisi.sahibi || kisi.username);

        } else {
            alert("Hatalı Giriş! Google Tablo'daki bilgileri kontrol edin.");
            btn.innerText = "Giriş Yap";
            btn.disabled = false;
        }
    } catch (h) {
        alert("Bağlantı Hatası: Google Sheets verisi alınamadı.");
        btn.disabled = false;
    }
}

function saatAyari(isim) {
    const saat = new Date().getHours();
    const alan = document.getElementById('mesaj-yazma-alani');
    if (saat >= 9 && saat < 22) {
        alan.innerHTML = `<textarea id="msg" placeholder="Mesajınızı yazın..."></textarea><button class="btn" onclick="mesajAt('${isim}')">Gönder</button>`;
    } else {
        alan.innerHTML = `<div class="time-badge">⚠️ Forum 22:00 - 09:00 arası kapalıdır.</div>`;
    }
}

function mesajAt(isim) {
    const m = document.getElementById('msg').value;
    window.open(`https://docs.google.com/forms/d/e/FORM_ID/viewform?entry.1=${encodeURIComponent(isim)}&entry.2=${encodeURIComponent(m)}`, '_blank');
}
</script>
</body>
</html>

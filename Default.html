// AYARLAR
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrCjNVASPnz9j40KxsZ7nCoIMBuqQLmxLiXmUM-CXTAp0cW03lM0YlJQMf7IJ054QmTvlTXp3iLMYj/pub?output=csv";

// --- OTOMATÄ°K GÄ°RÄ°Åž KONTROLÃœ (SAYFA AÃ‡ILDIÄžINDA) ---
window.onload = function() {
    const kayitliKullanici = localStorage.getItem('sakinGiris');
    if (kayitliKullanici) {
        const hesap = JSON.parse(kayitliKullanici);
        panelAc(hesap);
    }
};

// --- GÃœVENLÄ° Ã‡IKIÅž FONKSÄ°YONU (LOKAL BELLEÄžÄ° SÄ°LER) ---
function guvenliCikis() {
    localStorage.removeItem('sakinGiris');
    location.reload();
}

function toggleMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    sidebar.classList.toggle('active');
    overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
}

async function linkleriYukle() {
    try {
        const res = await fetch('./linkler.json?t=' + Date.now());
        const data = await res.json();
        const container = document.getElementById('menu-links-container');
        container.innerHTML = '';
        data.menuLinkleri.forEach(link => {
            container.innerHTML += `<a href="${link.url}">${link.ad}</a>`;
        });
    } catch (e) { console.error("Linkler okunamadÄ±."); }
}

function toggleNotif() {
    const popup = document.getElementById('notif-popup');
    popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
    document.getElementById('notif-badge').style.display = 'none';
    popup.style.opacity = "0.7";
}

async function duyurulariYukle() {
    try {
        const response = await fetch('./duyurular.json?t=' + Date.now());
        const data = await response.json();
        const listContainer = document.getElementById('announcement-list');
        listContainer.innerHTML = '';
        data.duyurular.slice().reverse().forEach(d => {
            listContainer.innerHTML += `
                <div class="announcement-item">
                    <div class="announcement-header">
                        <span class="announcement-name">ðŸ“¢ ${d.baslik}</span>
                        <span class="announcement-date">${d.tarih}</span>
                    </div>
                    <div class="announcement-body">${d.icerik}</div>
                </div>`;
        });
    } catch (e) { console.error("Duyurular yÃ¼klenemedi."); }
}

// PANELÄ° AÃ‡AN VE VERÄ°LERÄ° Ã‡EKEN ANA FONKSÄ°YON
async function panelAc(hesap) {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('loader').style.display = "block";

    try {
        const bResp = await fetch(csvUrl + "&t=" + Date.now());
        const csv = await bResp.text();
        const rows = csv.split(/\r?\n/).filter(r => r.trim() !== '');
        const sep = rows[0].includes(';') ? ';' : ',';
        const headers = rows[0].split(sep).map(h => h.trim());
        const veriler = rows.slice(1).map(row => {
            const cols = row.split(sep).map(c => c.trim().replace(/^"|"$/g, ''));
            let item = {};
            headers.forEach((h, i) => item[h] = cols[i] || "");
            return item;
        });

        const detay = veriler.find(d => String(d.daireNo) === String(hesap.daireNo));

        if (detay) {
            document.getElementById('display-name').innerText = "Sn. " + detay.sahibi;
            document.getElementById('val-no').innerText = detay.daireNo;
            document.getElementById('val-aidat').innerText = (detay.aidatBorcu || "0") + " TL";
            document.getElementById('val-yakit').innerText = (detay.yakitBorcu || "0") + " TL";
            document.getElementById('val-diger').innerText = (detay.digerBorc || "0") + " TL";
            
            if(detay.not && detay.not !== "") {
                document.getElementById('bell-icon').style.display = 'block';
                document.getElementById('notif-text').innerText = detay.not;
                document.getElementById('notif-badge').style.display = 'block';
            }

            document.getElementById('menu-icon').style.display = 'block';
            await linkleriYukle();
            await duyurulariYukle();

            document.getElementById('loader').style.display = "none";
            document.getElementById('info-panel').style.display = 'block';
        }
    } catch (e) {
        guvenliCikis(); // Hata varsa temizle
    }
}

async function sistemeGirisYap() {
    const userIn = document.getElementById('username').value.trim();
    const passIn = document.getElementById('password').value.trim();
    const loader = document.getElementById('loader');
    const btn = document.getElementById('loginBtn');

    if (!userIn || !passIn) return alert("Bilgileri girin.");
    btn.style.display = "none";
    loader.style.display = "block";

    try {
        const sResp = await fetch('./sifreler.json?t=' + Date.now());
        const sData = await sResp.json();
        const hesap = sData.hesaplar.find(h => h.username === userIn && String(h.password) === passIn);

        if (!hesap) throw new Error("Hata");

        // GÄ°RÄ°Åž BAÅžARILI: BelleÄŸe kaydet
        localStorage.setItem('sakinGiris', JSON.stringify(hesap));
        panelAc(hesap);

    } catch (e) {
        alert("HatalÄ± GiriÅŸ!");
        loader.style.display = "none";
        btn.style.display = "block";
    }
}
